steps:
- checkout: self
  displayName: checkout GE api
  fetchDepth: 1
  submodules: recursive
  persistCredentials: true

- task: DownloadPipelineArtifact@2
  displayName: 'Download snippets artifact'
  inputs:
    artifact: 'Snippets'
    path: '$(Build.ArtifactStagingDirectory)/Snippets'
    extractTars: true

- task: UseDotNet@2
  displayName: 'Install .NET Core SDK 6'
  inputs:
    version: 6.x

- task: UseDotNet@2
  displayName: 'Install .NET Core SDK 7'
  inputs:
    version: 7.0.x

- task: DotNetCoreCLI@2
  displayName: 'Build CodeSnippetsPipeline.Test'
  inputs:
    command: 'build'
    projects: '**/CodeSnippetsPipeline.Test.csproj'
    arguments: '--configuration $(buildConfiguration)'

- pwsh: |
    Write-Host "Running tests for language: $env:SNIPPET_LANGUAGE, version: $env:GRAPH_VERSION"
    ls $env:BUILD_ARTIFACTSTAGINGDIRECTORY/Snippets

- task: DotNetCoreCLI@2
  displayName: 'Run CodeSnippetsPipeline.Test'
  inputs:
    command: 'test'
    projects: '**/CodeSnippetsPipeline.Test.csproj'
    arguments: '--configuration $(buildConfiguration) --logger trx;LogFileName=TestResults.trx --results-directory $(Build.ArtifactStagingDirectory)/TestResults'
    publishTestResults: true
  env:
    SNIPPETS_PATH: '$(Build.ArtifactStagingDirectory)/Snippets'

- task: PublishTestResults@2
  displayName: 'Publish test results'
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/TestResults.trx'
    mergeTestResults: false
    failTaskOnFailedTests: true