steps:
- checkout: self
  displayName: checkout GE api
  fetchDepth: 1
  submodules: recursive
  persistCredentials: true

- task: DownloadPipelineArtifact@2
  displayName: 'Download snippets artifact'
  inputs:
    artifact: 'Snippets'
    path: '$(Build.ArtifactStagingDirectory)/Snippets'

- task: ExtractFiles@1
  displayName: 'Extract snippets artifact'
  inputs:
    archiveFilePatterns: '$(Build.ArtifactStagingDirectory)/Snippets/*.tar'
    destinationFolder: '$(Build.ArtifactStagingDirectory)/Snippets'
    cleanDestinationFolder: false

- task: UseDotNet@2
  displayName: 'Install .NET Core SDK 6'
  inputs:
    version: 6.x

- task: UseDotNet@2
  displayName: 'Install .NET Core SDK 7'
  inputs:
    version: 7.0.x

- task: DotNetCoreCLI@2
  displayName: 'Build CodeSnippetsPipeline.Test'
  inputs:
    command: 'build'
    projects: '**/CodeSnippetsPipeline.Test.csproj'
    arguments: '--configuration $(buildConfiguration)'

- pwsh: |
    Write-Host "Running tests for language: $env:SNIPPET_LANGUAGE, version: $env:GRAPH_VERSION"
    dotnet test ./CodeSnippetsPipeline.Test/ --configuration $env:BUILD_CONFIGURATION --logger trx;LogFileName=TestResults.trx --results-directory $env:BUILD_ARTIFACTSTAGINGDIRECTORY/TestResults
  displayName: 'Run CodeSnippetsPipeline.Test'
  env:
    BUILD_CONFIGURATION: '$(buildConfiguration)'
    SNIPPETS_PATH: '$(Build.ArtifactStagingDirectory)/Snippets'
  continueOnError: true

- task: PublishTestResults@2
  displayName: 'Publish test results'
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/TestResults.trx'
    searchFolder: '$(Build.ArtifactStagingDirectory)/TestResults'
    mergeTestResults: false
    failTaskOnFailedTests: true